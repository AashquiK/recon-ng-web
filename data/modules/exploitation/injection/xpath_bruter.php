<?php
ini_set('max_execution_time',500);
//Module details
$module_name_here = "Xpath Injection Brute Forcer";
$module_path_here = "exploitation/injection/xpath_bruter";
$allowed_actions = ["options", "info"];

//Run module
if(isset($_POST['module_option_baseurl']) && strlen($_POST['module_option_baseurl'])>0 && isset($_POST['module_option_parameters']) && strlen($_POST['module_option_parameters'])>0 && isset($_POST['module_option_post']) && strlen($_POST['module_option_post'])>0 && isset($_POST['module_option_string']) && strlen($_POST['module_option_string'])>0)
{
    //Configuration & Functions
    require_once("../../../../includes/config.php");
    require_once("../../../../includes/functions.php");
    $module_baseurl = urldecode($_POST['module_option_baseurl']);
    $module_parameters = urldecode($_POST['module_option_parameters']);
    $module_post = urldecode($_POST['module_option_post']);
    $module_string = urldecode($_POST['module_option_string']);
    $sid = manager_recon("init", NULL);
    $use_module = manager_recon("use", array($module_path_here, $sid));
    $set_module_baseurl = manager_recon("set", array('BASE_URL', $module_baseurl, $sid));
    $set_module_parameters = manager_recon("set", array('PARAMETERS', $module_parameters, $sid));
    $set_module_post = manager_recon("set", array('POST', $module_post, $sid));
    $set_module_string = manager_recon("set", array('STRING', $module_string, $sid));
    if(isset($_POST['module_option_basicpass']) && strlen($_POST['module_option_basicpass'])>0)
    {
        $set_module_basicpass = manager_recon("set", array('BASIC_PASS', urldecode($_POST['module_option_basicpass']), $sid));
    }
    if(isset($_POST['module_option_basicuser']) && strlen($_POST['module_option_basicuser'])>0)
    {
        $set_module_basicuser = manager_recon("set", array('BASIC_USER', urldecode($_POST['module_option_basicuser']), $sid));
    }
    if(isset($_POST['module_option_cookie']) && strlen($_POST['module_option_cookie'])>0)
    {
        $set_module_cookie = manager_recon("set", array('COOKIE', urldecode($_POST['module_option_cookie']), $sid));
    }
    $run_module = manager_recon("run", $sid);
    echo "<pre>";
    print_r($run_module);
    echo "</pre>";
    return;
}

//Show data based on action
if(strlen($action)>0 && in_array($action, $allowed_actions))
{
    if($action=="options")
    {
?>
        Module Name: <b><?php echo $module_name_here; ?></b><br>
        Module path: <b><?php echo $module_path_here; ?></b><br>
        <br><br>
        <form role='form' id='runmodule' action='' method='post'>
        BASE_URL: <input type='text' name='module_option_baseurl' value="" class='form-control'><br>
        BASIC_PASS: <input type='text' name='module_option_basicpass' value="" class='form-control'><br>
        BASIC_USER: <input type='text' name='module_option_basicuser' value="" class='form-control'><br>
        COOKIE: <input type='text' name='module_option_cookie' value="" class='form-control'><br>
        PARAMETERS: <input type='text' name='module_option_parameters' value="" class='form-control'><br>
        POST: <input type='text' name='module_option_post' value="False" class='form-control'><br>
        STRING: <input type='text' name='module_option_string' value="" class='form-control'><br>
        <button type='submit' class='btn btn-success'>Run</button><br></form>
<?php
    }
    elseif($action=="info")
    {
?>
        Name: <?php echo $module_name_here; ?><br>
        Path: <?php echo "modules/$module_path_here.py"; ?><br>
        Author: Tim Tomes (@LaNMaSteR53)<br>
        <br>
        Description:<br>Exploits XPath injection flaws to enumerate the contents of serverside XML documents.<br>
        <br>
        Options:<br>
        <table class='table'>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Current Value</th>
                    <th>Required</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>BASE_URL</td>
                    <td></td>
                    <td>yes</td>
                    <td>the target resource url excluding any parameters</td>
                </tr>
                <tr>
                    <td>BASIC_PASS</td>
                    <td></td>
                    <td>no</td>
                    <td>password for basic authentication</td>
                </tr>
                <tr>
                    <td>BASIC_USER</td>
                    <td></td>
                    <td>no</td>
                    <td>username for basic authentication</td>
                </tr>
                <tr>
                    <td>COOKIE</td>
                    <td></td>
                    <td>no</td>
                    <td>cookie string containing authenticated session data</td>
                </tr>
                <tr>
                    <td>PARAMETERS</td>
                    <td></td>
                    <td>yes</td>
                    <td>query parameters with '&lt;inject&gt;' signifying the injection</td>
                </tr>
                <tr>
                    <td>POST</td>
                    <td>False</td>
                    <td>yes</td>
                    <td>set the request method to post. parameters should still be submitted in the url option</td>
                </tr>
                <tr>
                    <td>STRING</td>
                    <td></td>
                    <td>yes</td>
                    <td>unique string found when the injection results in 'True'</td>
                </tr>
            </tbody>
        </table>
        <script>
        $("#runmodule").submit(function(e){    
                e.preventDefault();  
                $( "#result" ).empty().append( "" );
                $( "#loading" ).empty().append( '<img src="img/loading64.gif" alt="Loading..." width="" height="">' );
                $.post("<?php echo "data/modules/$module_path_here.php"; ?>", $("#runmodule").serialize(),
                function(data){
                    $( "#loading" ).empty().append( "" );
                    $( "#result" ).empty().append( data );
                    var mydata = $("#result").html();
                });
        });
        </script>
<?php
    }
    else
    {
        echo "Invalid action";
    }
}
else
{
    echo "Invalid action";
}
?>